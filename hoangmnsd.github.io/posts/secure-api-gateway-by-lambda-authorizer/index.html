<!DOCTYPE html>
<html lang='en' dir='auto'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Bài này sẽ giải thích cách Secure API Gateway bằng Lambda Authorizer đơn giản. '>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Secure API Gateway by Lambda Authorizer • hoangmnsd'>
<meta property='og:description' content='Bài này sẽ giải thích cách Secure API Gateway bằng Lambda Authorizer đơn giản. '>
<meta property='og:url' content='https://hoangmnsd.github.io/posts/secure-api-gateway-by-lambda-authorizer/'>
<meta property='og:site_name' content='Hoang'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/7a4fb984a45dfe1129362728655c0b75?s=256'><meta property='article:section' content='posts'><meta property='article:tag' content='AWS'><meta property='article:tag' content='APIGateway'><meta property='article:tag' content='Lambda'><meta property='article:published_time' content='2019-07-29T09:53:45&#43;09:00'/><meta property='article:modified_time' content='2019-07-29T09:53:45&#43;09:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.85.0" />

  <title>Secure API Gateway by Lambda Authorizer • hoangmnsd</title>
  <link rel='canonical' href='https://hoangmnsd.github.io/posts/secure-api-gateway-by-lambda-authorizer/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#ffcd00;}
</style>

  

</head>
<body class='page type-posts has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.png'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      Hoang
      </a>
    </h2>
    <div class='desc'>
    Learn something new everyday 😋
    </div>
  </header>

</section>
<section class='widget widget-search sep-after'>
  <header>
    <h4 class='title widget-title'>Search</h4>
  </header>

  <form action='/search' id='search-form' class='search-form'>
    <label>
      <span class='screen-reader-text'>Search</span>
      <input id='search-term' class='search-term' type='search' name='q' placeholder='Search&hellip;'>
    </label></form>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/posts/'>Posts</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/aci/' style='font-size:1.0625em'>ACI</a>
      </li><li>
        <a href='/tags/ajax/' style='font-size:1em'>Ajax</a>
      </li><li>
        <a href='/tags/aks/' style='font-size:1em'>AKS</a>
      </li><li>
        <a href='/tags/ansible/' style='font-size:1.1875em'>Ansible</a>
      </li><li>
        <a href='/tags/apigateway/' style='font-size:1.0625em'>APIGateway</a>
      </li><li>
        <a href='/tags/argocd/' style='font-size:1em'>Argocd</a>
      </li><li>
        <a href='/tags/aws/' style='font-size:1.75em'>AWS</a>
      </li><li>
        <a href='/tags/azure/' style='font-size:1.6875em'>Azure</a>
      </li><li>
        <a href='/tags/bayes/' style='font-size:1em'>Bayes</a>
      </li><li>
        <a href='/tags/blog/' style='font-size:1.125em'>Blog</a>
      </li><li>
        <a href='/tags/cert-manager/' style='font-size:1em'>Cert-manager</a>
      </li><li>
        <a href='/tags/chatgpt/' style='font-size:1em'>ChatGPT</a>
      </li><li>
        <a href='/tags/ci/cd/' style='font-size:1.1875em'>CI/CD</a>
      </li><li>
        <a href='/tags/circleci/' style='font-size:1em'>CircleCI</a>
      </li><li>
        <a href='/tags/cnab/' style='font-size:1em'>CNAB</a>
      </li><li>
        <a href='/tags/cognito/' style='font-size:1.0625em'>Cognito</a>
      </li><li>
        <a href='/tags/discord/slack/' style='font-size:1em'>Discord/Slack</a>
      </li><li>
        <a href='/tags/docker/' style='font-size:1.125em'>Docker</a>
      </li><li>
        <a href='/tags/docker-compose/' style='font-size:1.0625em'>Docker-compose</a>
      </li><li>
        <a href='/tags/efk/' style='font-size:1.0625em'>EFK</a>
      </li><li>
        <a href='/tags/eks/' style='font-size:1em'>EKS</a>
      </li><li>
        <a href='/tags/eksctl/' style='font-size:1.0625em'>eksctl</a>
      </li><li>
        <a href='/tags/elasticsearch/' style='font-size:1.0625em'>ElasticSearch</a>
      </li><li>
        <a href='/tags/externaldns/' style='font-size:1em'>ExternalDNS</a>
      </li><li>
        <a href='/tags/fluentd/' style='font-size:1.0625em'>Fluentd</a>
      </li><li>
        <a href='/tags/flux/' style='font-size:1em'>Flux</a>
      </li><li>
        <a href='/tags/football/' style='font-size:1em'>Football</a>
      </li><li>
        <a href='/tags/gatsbyjs/' style='font-size:1.125em'>GatsbyJS</a>
      </li><li>
        <a href='/tags/gcp/' style='font-size:1.0625em'>GCP</a>
      </li><li>
        <a href='/tags/geography/' style='font-size:1em'>Geography</a>
      </li><li>
        <a href='/tags/git/' style='font-size:1.0625em'>Git</a>
      </li><li>
        <a href='/tags/github/' style='font-size:1em'>Github</a>
      </li><li>
        <a href='/tags/gitlab/' style='font-size:1.25em'>Gitlab</a>
      </li><li>
        <a href='/tags/gke/' style='font-size:1.125em'>GKE</a>
      </li><li>
        <a href='/tags/helm/' style='font-size:1em'>Helm</a>
      </li><li>
        <a href='/tags/homeassistant/' style='font-size:1.4375em'>HomeAssistant</a>
      </li><li>
        <a href='/tags/hugo/' style='font-size:1em'>Hugo</a>
      </li><li>
        <a href='/tags/iot/' style='font-size:1em'>IoT</a>
      </li><li>
        <a href='/tags/iptables/' style='font-size:1em'>Iptables</a>
      </li><li>
        <a href='/tags/jquery/' style='font-size:1em'>Jquery</a>
      </li><li>
        <a href='/tags/js/' style='font-size:1em'>Js</a>
      </li><li>
        <a href='/tags/keel/' style='font-size:1em'>Keel</a>
      </li><li>
        <a href='/tags/kibana/' style='font-size:1.0625em'>Kibana</a>
      </li><li>
        <a href='/tags/kubectl/' style='font-size:1em'>kubectl</a>
      </li><li>
        <a href='/tags/kubernetes/' style='font-size:2em'>Kubernetes</a>
      </li><li>
        <a href='/tags/lambda/' style='font-size:1.1875em'>Lambda</a>
      </li><li>
        <a href='/tags/letsecrypt/' style='font-size:1em'>Letsecrypt</a>
      </li><li>
        <a href='/tags/letsencrypt/' style='font-size:1em'>Letsencrypt</a>
      </li><li>
        <a href='/tags/locust/' style='font-size:1em'>Locust</a>
      </li><li>
        <a href='/tags/nginx/' style='font-size:1.0625em'>Nginx</a>
      </li><li>
        <a href='/tags/notes/' style='font-size:1.9375em'>Notes</a>
      </li><li>
        <a href='/tags/openldap/' style='font-size:1em'>OpenLDAP</a>
      </li><li>
        <a href='/tags/openssl/' style='font-size:1em'>OpenSSL</a>
      </li><li>
        <a href='/tags/oraclecloud/' style='font-size:1.0625em'>OracleCloud</a>
      </li><li>
        <a href='/tags/packer/' style='font-size:1em'>Packer</a>
      </li><li>
        <a href='/tags/postgresql/' style='font-size:1em'>Postgresql</a>
      </li><li>
        <a href='/tags/proxy/' style='font-size:1em'>Proxy</a>
      </li><li>
        <a href='/tags/python/' style='font-size:1.25em'>Python</a>
      </li><li>
        <a href='/tags/raspberrypi/' style='font-size:1.1875em'>RaspberryPi</a>
      </li><li>
        <a href='/tags/reactjs/' style='font-size:1em'>ReactJS</a>
      </li><li>
        <a href='/tags/selenium/' style='font-size:1em'>Selenium</a>
      </li><li>
        <a href='/tags/sonarqube/' style='font-size:1em'>Sonarqube</a>
      </li><li>
        <a href='/tags/synapse/' style='font-size:1.0625em'>Synapse</a>
      </li><li>
        <a href='/tags/telegram/' style='font-size:1.0625em'>Telegram</a>
      </li><li>
        <a href='/tags/test/' style='font-size:1em'>Test</a>
      </li><li>
        <a href='/tags/ubuntu/' style='font-size:1.0625em'>Ubuntu</a>
      </li><li>
        <a href='/tags/windows/' style='font-size:1.0625em'>Windows</a>
      </li><li>
        <a href='/tags/wsl/' style='font-size:1em'>WSL</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><line x1="3" y1="12" x2="21" y2="12" />
<line x1="3" y1="6" x2="21" y2="6" />
<line x1="3" y1="18" x2="21" y2="18" />
</svg>
</span>
  <span class='close'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><line x1="18" y1="6" x2="6" y2="18" />
<line x1="6" y1="6" x2="18" y2="18" />
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/posts/'>Posts</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'>
    
    <style>.widget-breadcrumbs li:after{content:'\2f '}</style>
  <section class='widget widget-breadcrumbs sep-after'>
    <nav id='breadcrumbs'>
      <ol><li><a href='/'>Home</a></li><li><a href='/posts/'>Posts</a></li><li><span>Secure API Gateway by Lambda Authorizer</span></li></ol>
    </nav>
  </section></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Hoang</p><p class='desc site-desc'>Learn something new everyday 😋</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Secure API Gateway by Lambda Authorizer</h1>
      
<p class='desc'>Bài này sẽ giải thích cách Secure API Gateway bằng Lambda Authorizer đơn giản. </p>


    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
<line x1="16" y1="2" x2="16" y2="6" />
<line x1="8" y1="2" x2="8" y2="6" />
<line x1="3" y1="10" x2="21" y2="10" />
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2019-07-29T09:53:45&#43;09:00'>2019, Jul 29</time>
</span>

  <span class='byline'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1" />
<path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z" />
</svg>
<span class='screen-reader-text'> by </span><a href='/authors/hoangmnsd'>hoangmnsd</a></span>
  
<span class='reading-time'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><circle cx="12" cy="12" r="10" />
<polyline points="12 6 12 12 15 15" />
</svg>
15 mins read
</span>


</div>


  </div>
</header>

  
  
<details class='container entry-toc'>
  <summary class='title'>
    <span>Table of Contents</span>
  </summary>
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-tạo-table-trong-dynamodb">1. Tạo table trong DynamoDB</a></li>
        <li><a href="#2-tạo-role-cho-lambda-function">2. Tạo role cho Lambda function</a></li>
        <li><a href="#3-tạo-lambda-function-get-all-authors-py-để-get-all-thông-tin-user-từ-dynamodb">3. Tạo Lambda function &ldquo;get-all-authors-py&rdquo; để get all thông tin user từ DynamoDB</a></li>
        <li><a href="#4-setup-api-gateway">4. Setup API Gateway</a></li>
        <li><a href="#5-secure-api-gateway-bằng-lambda-authorizer-cách-1-đơn-giản">5. Secure API Gateway bằng Lambda Authorizer (Cách 1, Đơn giản)</a>
          <ul>
            <li><a href="#51-tạo-1-lambda-function-để-thực-hiện-nhiệm-vụ-authorizer">5.1. Tạo 1 Lambda function để thực hiện nhiệm vụ Authorizer</a></li>
            <li><a href="#52-setup-authorizer-trong-api-gateway">5.2. Setup Authorizer trong API Gateway</a></li>
            <li><a href="#53-test-method-get-trên-postman">5.3. Test method GET trên Postman</a></li>
          </ul>
        </li>
        <li><a href="#6-secure-api-gateway-bằng-lambda-authorizer-cách-2-dùng-encode-và-decode-jwt">6. Secure API Gateway bằng Lambda Authorizer (Cách 2, dùng encode và decode JWT)</a>
          <ul>
            <li><a href="#61-tạo-1-lambda-function-để-thực-hiện-nhiệm-vụ-authorizer">6.1. Tạo 1 Lambda function để thực hiện nhiệm vụ Authorizer</a></li>
            <li><a href="#62-rồi-run-các-command-sau-để-đóng-package-lambda-với-thư-viện-jwt-bên-ngoài-lại">6.2. Rồi run các command sau để đóng package lambda với thư viện jwt bên ngoài lại</a></li>
            <li><a href="#63-rồi-giờ-up-file-zip-này-lên-aws-lambda">6.3. Rồi giờ up file zip này lên AWS Lambda</a></li>
            <li><a href="#65-setup-authorizer-trong-api-gateway">6.5. Setup Authorizer trong API Gateway</a></li>
            <li><a href="#66-test-method-get-trên-postman">6.6. Test method GET trên Postman</a></li>
          </ul>
        </li>
        <li><a href="#source-tham-khảo">Source tham khảo</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>


  <div class='container entry-content'>
  <p>Bài này sẽ giải thích cách Secure API Gateway bằng Lambda Authorizer đơn giản.</p>
<p>Nếu API không được secure thì bất cứ ai có API URL cũng có thể gửi request đến server và lấy được data trong DynamoDB của mình.</p>
<p>Nên cần phải setup Authorization cho API Gateway.</p>
<h2 id="1-tạo-table-trong-dynamodb">1. Tạo table trong DynamoDB</h2>
<p>Table name: authors</p>
<p>Primary key: id</p>
<p>Tạo vài item trong table authors</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;firstName&#34;</span>: <span style="color:#e6db74">&#34;Hoang&#34;</span>,
  <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;le-hoang&#34;</span>,
  <span style="color:#e6db74">&#34;lastName&#34;</span>: <span style="color:#e6db74">&#34;Le&#34;</span>
<span style="color:#f92672">}</span>,
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;linoel-messi&#34;</span>,
  <span style="color:#e6db74">&#34;firstName&#34;</span>: <span style="color:#e6db74">&#34;lionel&#34;</span>,
  <span style="color:#e6db74">&#34;lastName&#34;</span>: <span style="color:#e6db74">&#34;messi&#34;</span>
<span style="color:#f92672">}</span>,
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;jonesta-smaldini&#34;</span>,
  <span style="color:#e6db74">&#34;firstName&#34;</span>: <span style="color:#e6db74">&#34;jonesta&#34;</span>,
  <span style="color:#e6db74">&#34;lastName&#34;</span>: <span style="color:#e6db74">&#34;smaldini&#34;</span>
<span style="color:#f92672">}</span>,
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;firstName&#34;</span>: <span style="color:#e6db74">&#34;Fred&#34;</span>,
  <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;fred&#34;</span>,
  <span style="color:#e6db74">&#34;lastName&#34;</span>: <span style="color:#e6db74">&#34;the-red&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="2-tạo-role-cho-lambda-function">2. Tạo role cho Lambda function</h2>
<p>Đoạn code bên dưới bạn cần sửa <code>region</code> và <code>accountId</code> phù hợp với môi trường bạn đang test:
ví dụ <code>region</code> = us-east-1, <code>accountId</code> = 923423492348</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;Version&#34;</span>: <span style="color:#e6db74">&#34;2012-10-17&#34;</span>,
    <span style="color:#e6db74">&#34;Statement&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
            <span style="color:#e6db74">&#34;Action&#34;</span>: <span style="color:#f92672">[</span>
                <span style="color:#e6db74">&#34;dynamodb:DeleteItem&#34;</span>,
                <span style="color:#e6db74">&#34;dynamodb:GetItem&#34;</span>,
                <span style="color:#e6db74">&#34;dynamodb:PutItem&#34;</span>,
                <span style="color:#e6db74">&#34;dynamodb:Scan&#34;</span>,
                <span style="color:#e6db74">&#34;dynamodb:UpdateItem&#34;</span>
            <span style="color:#f92672">]</span>,
            <span style="color:#e6db74">&#34;Resource&#34;</span>: <span style="color:#e6db74">&#34;arn:aws:dynamodb:region:accountId:table/*&#34;</span>
        <span style="color:#f92672">}</span>,
        <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
            <span style="color:#e6db74">&#34;Action&#34;</span>: <span style="color:#f92672">[</span>
                <span style="color:#e6db74">&#34;logs:CreateLogGroup&#34;</span>,
                <span style="color:#e6db74">&#34;logs:CreateLogStream&#34;</span>,
                <span style="color:#e6db74">&#34;logs:PutLogEvents&#34;</span>
            <span style="color:#f92672">]</span>,
            <span style="color:#e6db74">&#34;Resource&#34;</span>: <span style="color:#e6db74">&#34;arn:aws:logs:*:*:*&#34;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="3-tạo-lambda-function-get-all-authors-py-để-get-all-thông-tin-user-từ-dynamodb">3. Tạo Lambda function &ldquo;get-all-authors-py&rdquo; để get all thông tin user từ DynamoDB</h2>
<p>Gắn Role vừa tạo ở Step 2 vào.</p>
<p>Nội dung function viết bằng python 3.7:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">import boto3
import json

print<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Loading function&#39;</span><span style="color:#f92672">)</span>
dynamodb <span style="color:#f92672">=</span> boto3.resource<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;dynamodb&#39;</span><span style="color:#f92672">)</span>
table <span style="color:#f92672">=</span> dynamodb.Table<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;authors&#39;</span><span style="color:#f92672">)</span>

def respond<span style="color:#f92672">(</span>err, res<span style="color:#f92672">=</span>None<span style="color:#f92672">)</span>:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#e6db74">&#39;400&#39;</span> <span style="color:#66d9ef">if</span> err <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;200&#39;</span>,
        <span style="color:#e6db74">&#39;body&#39;</span>: err.message <span style="color:#66d9ef">if</span> err <span style="color:#66d9ef">else</span>  json.dumps<span style="color:#f92672">(</span>res<span style="color:#f92672">)</span>,
        <span style="color:#e6db74">&#39;headers&#39;</span>: <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#39;Content-Type&#39;</span>: <span style="color:#e6db74">&#39;application/json&#39;</span>,
        <span style="color:#f92672">}</span>,
    <span style="color:#f92672">}</span>
def lambda_handler<span style="color:#f92672">(</span>event, context<span style="color:#f92672">)</span>:
    scan_response <span style="color:#f92672">=</span> table.scan<span style="color:#f92672">()</span>
    print<span style="color:#f92672">(</span>scan_response<span style="color:#f92672">)</span>
    <span style="color:#75715e"># return respond(None, scan_response[&#39;Items&#39;])</span>
    <span style="color:#66d9ef">return</span> scan_response<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;Items&#39;</span><span style="color:#f92672">]</span>
</code></pre></div><h2 id="4-setup-api-gateway">4. Setup API Gateway</h2>
<p>Tạo resource: /authors</p>
<p>Trong resource /authors, tạo method GET</p>
<p>Phần Integration Request chọn Lambda function vừa tạo <code>get-all-authors-py</code></p>
<p>Ban đầu chưa cần setup Authorization cho method này nên hãy để NONE (ảnh)
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-setup-get-not-authorization.jpg" alt=""></p>
<p>Test thử xem lấy được data là OK (ảnh)
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-setup-get-not-authorization-test.jpg" alt=""></p>
<p>Deploy API</p>
<h2 id="5-secure-api-gateway-bằng-lambda-authorizer-cách-1-đơn-giản">5. Secure API Gateway bằng Lambda Authorizer (Cách 1, Đơn giản)</h2>
<p>Bản chất là mình sẽ tạo thêm 1 function Lambda nữa để nó handler các request gửi tới API Gateway,
nhiệm vụ là xác định request đó có hợp lệ không,
nếu hợp lệ thì mới từ API Gateway chuyển request đến Lambda function <code>get-all-authors-py</code>.</p>
<h3 id="51-tạo-1-lambda-function-để-thực-hiện-nhiệm-vụ-authorizer">5.1. Tạo 1 Lambda function để thực hiện nhiệm vụ Authorizer</h3>
<p>Tên function: &ldquo;tokenBasedLambdaAuthorizerBasic&rdquo;.
Gắn Role vừa tạo ở Step 2 vào.</p>
<p>Source này mình lấy từ Blueprint của AWS (blueprint là những template AWS recommend mình sử dụng), thêm 1 đoạn code nhỏ:</p>
<p>Nếu Header của request mà có authorizationToken=&ldquo;what-the-fuck&rdquo; thì dc allowAllMethods, ngược lại thì denyAllMethods</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">Copyright 2015-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Licensed under the Apache License, Version 2.0 (the &#34;</span>License<span style="color:#e6db74">&#34;). You may not use this file except in compliance with the License. A copy of the License is located at
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">     http://aws.amazon.com/apache2.0/
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">or in the &#34;</span>license<span style="color:#e6db74">&#34; file accompanying this file. This file is distributed on an &#34;</span>AS IS<span style="color:#e6db74">&#34; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
from __future__ import print_function

import re
import time, datetime
import pprint
import json


def lambda_handler<span style="color:#f92672">(</span>event, context<span style="color:#f92672">)</span>:
    print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Client token: &#34;</span> + event<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;authorizationToken&#39;</span><span style="color:#f92672">])</span>
    print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Method ARN: &#34;</span> + event<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;methodArn&#39;</span><span style="color:#f92672">])</span>
    <span style="color:#e6db74">&#34;&#34;&#34;validate the incoming token&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;and produce the principal user identifier associated with the token&#34;&#34;&#34;</span>
    <span style="color:#75715e"># Hoang start</span>
    token<span style="color:#f92672">=</span>event<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;authorizationToken&#34;</span><span style="color:#f92672">]</span>
    principalId <span style="color:#f92672">=</span> token
    print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;principalId: &#34;</span> + principalId<span style="color:#f92672">)</span>
    <span style="color:#75715e"># Hoang end</span>

    <span style="color:#e6db74">&#34;&#34;&#34;this could be accomplished in a number of ways:&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;1. Call out to OAuth provider&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;2. Decode a JWT token inline&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;3. Lookup in a self-managed DB&#34;&#34;&#34;</span>
    <span style="color:#75715e"># principalId = &#34;user|a1b2c3d4&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;you can send a 401 Unauthorized response to the client by failing like so:&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;raise Exception(&#39;Unauthorized&#39;)&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;if the token is valid, a policy must be generated which will allow or deny access to the client&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;if access is denied, the client will recieve a 403 Access Denied response&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;if access is allowed, API Gateway will proceed with the backend integration configured on the method that was called&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;this function must generate a policy that is associated with the recognized principal user identifier.&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;depending on your use case, you might store policies in a DB, or generate them on the fly&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;keep in mind, the policy is cached for 5 minutes by default (TTL is configurable in the authorizer)&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;and will apply to subsequent calls to any method/resource in the RestApi&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;made with the same token&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;the example policy below denies access to all resources in the RestApi&#34;&#34;&#34;</span>
    tmp <span style="color:#f92672">=</span> event<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;methodArn&#39;</span><span style="color:#f92672">]</span>.split<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;:&#39;</span><span style="color:#f92672">)</span>
    apiGatewayArnTmp <span style="color:#f92672">=</span> tmp<span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>.split<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">)</span>
    awsAccountId <span style="color:#f92672">=</span> tmp<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>

    policy <span style="color:#f92672">=</span> AuthPolicy<span style="color:#f92672">(</span>principalId, awsAccountId<span style="color:#f92672">)</span>
    policy.restApiId <span style="color:#f92672">=</span> apiGatewayArnTmp<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
    policy.region <span style="color:#f92672">=</span> tmp<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>
    policy.stage <span style="color:#f92672">=</span> apiGatewayArnTmp<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>
    <span style="color:#75715e"># Hoang start</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>principalId <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;what-the-fuck&#34;</span><span style="color:#f92672">)</span>:
        policy.allowAllMethods<span style="color:#f92672">()</span>
    <span style="color:#66d9ef">else</span>:
        policy.denyAllMethods<span style="color:#f92672">()</span>
    <span style="color:#75715e"># Hoang end</span>
    <span style="color:#e6db74">&#34;&#34;&#34;policy.allowMethod(HttpVerb.GET, &#34;</span>/pets/*<span style="color:#e6db74">&#34;)&#34;&#34;&#34;</span>

    <span style="color:#75715e"># Finally, build the policy</span>
    authResponse <span style="color:#f92672">=</span> policy.build<span style="color:#f92672">()</span>
 
    <span style="color:#75715e"># new! -- add additional key-value pairs associated with the authenticated principal</span>
    <span style="color:#75715e"># these are made available by APIGW like so: $context.authorizer.&lt;key&gt;</span>
    <span style="color:#75715e"># additional context is cached</span>
    context <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#39;key&#39;</span>: <span style="color:#e6db74">&#39;value&#39;</span>, <span style="color:#75715e"># $context.authorizer.key -&gt; value</span>
        <span style="color:#e6db74">&#39;number&#39;</span> : 1,
        <span style="color:#e6db74">&#39;bool&#39;</span> : True
    <span style="color:#f92672">}</span>
    <span style="color:#75715e"># context[&#39;arr&#39;] = [&#39;foo&#39;] &lt;- this is invalid, APIGW will not accept it</span>
    <span style="color:#75715e"># context[&#39;obj&#39;] = {&#39;foo&#39;:&#39;bar&#39;} &lt;- also invalid</span>
 
    authResponse<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;context&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> context
    
    <span style="color:#66d9ef">return</span> authResponse

class HttpVerb:
    GET     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;GET&#34;</span>
    POST    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;POST&#34;</span>
    PUT     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PUT&#34;</span>
    PATCH   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PATCH&#34;</span>
    HEAD    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;HEAD&#34;</span>
    DELETE  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DELETE&#34;</span>
    OPTIONS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;OPTIONS&#34;</span>
    ALL     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span>

class AuthPolicy<span style="color:#f92672">(</span>object<span style="color:#f92672">)</span>:
    awsAccountId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The AWS account id the policy will be generated for. This is used to create the method ARNs.&#34;&#34;&#34;</span>
    principalId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The principal used for the policy, this should be a unique identifier for the end user.&#34;&#34;&#34;</span>
    version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2012-10-17&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The policy version used for the evaluation. This should always be &#39;2012-10-17&#39;&#34;&#34;&#34;</span>
    pathRegex <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;^[/.a-zA-Z0-9-\*]+</span>$<span style="color:#e6db74">&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The regular expression used to validate resource paths for the policy&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;these are the internal lists of allowed and denied methods. These are lists
</span><span style="color:#e6db74">    of objects and each object has 2 properties: A resource ARN and a nullable
</span><span style="color:#e6db74">    conditions statement.
</span><span style="color:#e6db74">    the build method processes these lists and generates the approriate
</span><span style="color:#e6db74">    statements for the final policy&#34;&#34;&#34;</span>
    allowMethods <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
    denyMethods <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>

    restApiId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The API Gateway API id. By default this is set to &#39;*&#39;&#34;&#34;&#34;</span>
    region <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The region where the API is deployed. By default this is set to &#39;*&#39;&#34;&#34;&#34;</span>
    stage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The name of the stage used in the policy. By default this is set to &#39;*&#39;&#34;&#34;&#34;</span>

    def __init__<span style="color:#f92672">(</span>self, principal, awsAccountId<span style="color:#f92672">)</span>:
        self.awsAccountId <span style="color:#f92672">=</span> awsAccountId
        self.principalId <span style="color:#f92672">=</span> principal
        self.allowMethods <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
        self.denyMethods <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>

    def _addMethod<span style="color:#f92672">(</span>self, effect, verb, resource, conditions<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds a method to the internal lists of allowed or denied methods. Each object in
</span><span style="color:#e6db74">        the internal list contains a resource ARN and a condition statement. The condition
</span><span style="color:#e6db74">        statement can be null.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> verb !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span> and not hasattr<span style="color:#f92672">(</span>HttpVerb, verb<span style="color:#f92672">)</span>:
            raise NameError<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Invalid HTTP verb &#34;</span> + verb + <span style="color:#e6db74">&#34;. Allowed verbs in HttpVerb class&#34;</span><span style="color:#f92672">)</span>
        resourcePattern <span style="color:#f92672">=</span> re.compile<span style="color:#f92672">(</span>self.pathRegex<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">if</span> not resourcePattern.match<span style="color:#f92672">(</span>resource<span style="color:#f92672">)</span>:
            raise NameError<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Invalid resource path: &#34;</span> + resource + <span style="color:#e6db74">&#34;. Path should match &#34;</span> + self.pathRegex<span style="color:#f92672">)</span>

        <span style="color:#66d9ef">if</span> resource<span style="color:#f92672">[</span>:1<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/&#34;</span>:
            resource <span style="color:#f92672">=</span> resource<span style="color:#f92672">[</span>1:<span style="color:#f92672">]</span>

        resourceArn <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;arn:aws:execute-api:&#34;</span> +
            self.region + <span style="color:#e6db74">&#34;:&#34;</span> +
            self.awsAccountId + <span style="color:#e6db74">&#34;:&#34;</span> +
            self.restApiId + <span style="color:#e6db74">&#34;/&#34;</span> +
            self.stage + <span style="color:#e6db74">&#34;/&#34;</span> +
            verb + <span style="color:#e6db74">&#34;/&#34;</span> +
            resource<span style="color:#f92672">)</span>

        <span style="color:#66d9ef">if</span> effect.lower<span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;allow&#34;</span>:
            self.allowMethods.append<span style="color:#f92672">({</span>
                <span style="color:#e6db74">&#39;resourceArn&#39;</span> : resourceArn,
                <span style="color:#e6db74">&#39;conditions&#39;</span> : conditions
            <span style="color:#f92672">})</span>
        <span style="color:#66d9ef">elif</span> effect.lower<span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;deny&#34;</span>:
            self.denyMethods.append<span style="color:#f92672">({</span>
                <span style="color:#e6db74">&#39;resourceArn&#39;</span> : resourceArn,
                <span style="color:#e6db74">&#39;conditions&#39;</span> : conditions
            <span style="color:#f92672">})</span>

    def _getEmptyStatement<span style="color:#f92672">(</span>self, effect<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Returns an empty statement object prepopulated with the correct action and the
</span><span style="color:#e6db74">        desired effect.&#34;&#34;&#34;</span>
        statement <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#39;Action&#39;</span>: <span style="color:#e6db74">&#39;execute-api:Invoke&#39;</span>,
            <span style="color:#e6db74">&#39;Effect&#39;</span>: effect<span style="color:#f92672">[</span>:1<span style="color:#f92672">]</span>.upper<span style="color:#f92672">()</span> + effect<span style="color:#f92672">[</span>1:<span style="color:#f92672">]</span>.lower<span style="color:#f92672">()</span>,
            <span style="color:#e6db74">&#39;Resource&#39;</span>: <span style="color:#f92672">[]</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> statement

    def _getStatementForEffect<span style="color:#f92672">(</span>self, effect, methods<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;This function loops over an array of objects containing a resourceArn and
</span><span style="color:#e6db74">        conditions statement and generates the array of statements for the policy.&#34;&#34;&#34;</span>
        statements <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>

        <span style="color:#66d9ef">if</span> len<span style="color:#f92672">(</span>methods<span style="color:#f92672">)</span> &gt; 0:
            statement <span style="color:#f92672">=</span> self._getEmptyStatement<span style="color:#f92672">(</span>effect<span style="color:#f92672">)</span>

            <span style="color:#66d9ef">for</span> curMethod in methods:
                <span style="color:#66d9ef">if</span> curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;conditions&#39;</span><span style="color:#f92672">]</span> is None or len<span style="color:#f92672">(</span>curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;conditions&#39;</span><span style="color:#f92672">])</span> <span style="color:#f92672">==</span> 0:
                    statement<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;Resource&#39;</span><span style="color:#f92672">]</span>.append<span style="color:#f92672">(</span>curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;resourceArn&#39;</span><span style="color:#f92672">])</span>
                <span style="color:#66d9ef">else</span>:
                    conditionalStatement <span style="color:#f92672">=</span> self._getEmptyStatement<span style="color:#f92672">(</span>effect<span style="color:#f92672">)</span>
                    conditionalStatement<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;Resource&#39;</span><span style="color:#f92672">]</span>.append<span style="color:#f92672">(</span>curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;resourceArn&#39;</span><span style="color:#f92672">])</span>
                    conditionalStatement<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;Condition&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;conditions&#39;</span><span style="color:#f92672">]</span>
                    statements.append<span style="color:#f92672">(</span>conditionalStatement<span style="color:#f92672">)</span>

            statements.append<span style="color:#f92672">(</span>statement<span style="color:#f92672">)</span>

        <span style="color:#66d9ef">return</span> statements

    def allowAllMethods<span style="color:#f92672">(</span>self<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds a &#39;*&#39; allow to the policy to authorize access to all methods of an API&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Allow&#34;</span>, HttpVerb.ALL, <span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#f92672">[])</span>

    def denyAllMethods<span style="color:#f92672">(</span>self<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds a &#39;*&#39; allow to the policy to deny access to all methods of an API&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Deny&#34;</span>, HttpVerb.ALL, <span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#f92672">[])</span>

    def allowMethod<span style="color:#f92672">(</span>self, verb, resource<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds an API Gateway method (Http verb + Resource path) to the list of allowed
</span><span style="color:#e6db74">        methods for the policy&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Allow&#34;</span>, verb, resource, <span style="color:#f92672">[])</span>

    def denyMethod<span style="color:#f92672">(</span>self, verb, resource<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds an API Gateway method (Http verb + Resource path) to the list of denied
</span><span style="color:#e6db74">        methods for the policy&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Deny&#34;</span>, verb, resource, <span style="color:#f92672">[])</span>

    def allowMethodWithConditions<span style="color:#f92672">(</span>self, verb, resource, conditions<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds an API Gateway method (Http verb + Resource path) to the list of allowed
</span><span style="color:#e6db74">        methods and includes a condition for the policy statement. More on AWS policy
</span><span style="color:#e6db74">        conditions here: http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Condition&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Allow&#34;</span>, verb, resource, conditions<span style="color:#f92672">)</span>

    def denyMethodWithConditions<span style="color:#f92672">(</span>self, verb, resource, conditions<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds an API Gateway method (Http verb + Resource path) to the list of denied
</span><span style="color:#e6db74">        methods and includes a condition for the policy statement. More on AWS policy
</span><span style="color:#e6db74">        conditions here: http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Condition&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Deny&#34;</span>, verb, resource, conditions<span style="color:#f92672">)</span>

    def build<span style="color:#f92672">(</span>self<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Generates the policy document based on the internal lists of allowed and denied
</span><span style="color:#e6db74">        conditions. This will generate a policy with two main statements for the effect:
</span><span style="color:#e6db74">        one statement for Allow and one statement for Deny.
</span><span style="color:#e6db74">        Methods that includes conditions will have their own statement in the policy.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>self.allowMethods is None or len<span style="color:#f92672">(</span>self.allowMethods<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> and
            <span style="color:#f92672">(</span>self.denyMethods is None or len<span style="color:#f92672">(</span>self.denyMethods<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">))</span>:
            raise NameError<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;No statements defined for the policy&#34;</span><span style="color:#f92672">)</span>

        policy <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#39;principalId&#39;</span> : self.principalId,
            <span style="color:#e6db74">&#39;policyDocument&#39;</span> : <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#39;Version&#39;</span> : self.version,
                <span style="color:#e6db74">&#39;Statement&#39;</span> : <span style="color:#f92672">[]</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        policy<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;policyDocument&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;Statement&#39;</span><span style="color:#f92672">]</span>.extend<span style="color:#f92672">(</span>self._getStatementForEffect<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Allow&#34;</span>, self.allowMethods<span style="color:#f92672">))</span>
        policy<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;policyDocument&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;Statement&#39;</span><span style="color:#f92672">]</span>.extend<span style="color:#f92672">(</span>self._getStatementForEffect<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Deny&#34;</span>, self.denyMethods<span style="color:#f92672">))</span>

        <span style="color:#66d9ef">return</span> policy
</code></pre></div><h3 id="52-setup-authorizer-trong-api-gateway">5.2. Setup Authorizer trong API Gateway</h3>
<p>Trong API Gateway, vào phần Authorizer, tạo 1 Authorizer tên <code>coursesLambdaAuthorizer</code> như sau (ảnh):
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/api-gateway-authorizer.jpg" alt=""></p>
<p>Vào phần Resource /authors, sửa Method Request GET như sau (ảnh):
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-resource-get-authors-method-request.jpg" alt=""></p>
<p>Enable CORS, sửa cái Access-Control-Allow-Headers lại bằng giá trị mình đã set ở Authorizer như hình sau (ảnh):
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-enable-cors.jpg" alt="">
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-enable-cors-2.jpg" alt=""></p>
<p>Deploy lại API.</p>
<h3 id="53-test-method-get-trên-postman">5.3. Test method GET trên Postman</h3>
<p>Nếu test trên console thì mặc định AWS sẽ bypass cái Authorizer luôn, nên phải test trên Postman</p>
<p>Nếu ko truyền gì vào Header <code>authorizationToken</code> thì message nội dung sẽ là unauthorized (ảnh)
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-test-authorizer-postman-1.jpg" alt=""></p>
<p>Nếu truyền &ldquo;what-the-fuck&rdquo; vào sẽ lấy được data (ảnh)
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-test-authorizer-postman-2.jpg" alt=""></p>
<p>Nếu truyền linh tinh thì message nội dung deny (ảnh)
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-test-authorizer-postman-3.jpg" alt=""></p>
<h2 id="6-secure-api-gateway-bằng-lambda-authorizer-cách-2-dùng-encode-và-decode-jwt">6. Secure API Gateway bằng Lambda Authorizer (Cách 2, dùng encode và decode JWT)</h2>
<h3 id="61-tạo-1-lambda-function-để-thực-hiện-nhiệm-vụ-authorizer">6.1. Tạo 1 Lambda function để thực hiện nhiệm vụ Authorizer</h3>
<p>Cách tạo như sau, vì cần import thư viện bên ngoài (jwt), ko có sẵn của AWS Lambda nên phải làm cách này:</p>
<p>Vào Lambda tạo 1 function trống tên &ldquo;tokenBasedLambdaAuthorizer&rdquo;,
Gắn role dc tạo từ Step 2, rồi để đó.</p>
<p>Dựng 1 Ec2 từ ami này &ldquo;ami-0080e4c5bc078760e&rdquo;</p>
<p>SSH vào Ec2, tạo lambda function file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">nano lambda_function.py
</code></pre></div><p>Đây là fuction được lấy từ blueprint của AWS, rồi mình modifed.</p>
<p>Nội dung add thêm là:</p>
<p>Đầu tiên decode token nhận dc, từ token đó lấy ra &ldquo;userRole&rdquo;, nếu &ldquo;userRole==admin&rdquo; thì allowAllMethods, còn ko thì denyAllMethods.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">Copyright 2015-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Licensed under the Apache License, Version 2.0 (the &#34;</span>License<span style="color:#e6db74">&#34;). You may not use this file except in compliance with the License. A copy of the License is located at
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">     http://aws.amazon.com/apache2.0/
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">or in the &#34;</span>license<span style="color:#e6db74">&#34; file accompanying this file. This file is distributed on an &#34;</span>AS IS<span style="color:#e6db74">&#34; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
from __future__ import print_function

import re
import time, datetime
import pprint
import json
from jose import jwk, jwt
from jose.utils import base64url_decode


def lambda_handler<span style="color:#f92672">(</span>event, context<span style="color:#f92672">)</span>:
    print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Client token: &#34;</span> + event<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;authorizationToken&#39;</span><span style="color:#f92672">])</span>
    print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Method ARN: &#34;</span> + event<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;methodArn&#39;</span><span style="color:#f92672">])</span>
    <span style="color:#e6db74">&#34;&#34;&#34;validate the incoming token&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;and produce the principal user identifier associated with the token&#34;&#34;&#34;</span>
    <span style="color:#75715e"># Hoang start</span>
    secret<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;my-secret&#34;</span>
    token<span style="color:#f92672">=</span>event<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;authorizationToken&#34;</span><span style="color:#f92672">]</span>
    decoded<span style="color:#f92672">=</span>jwt.decode<span style="color:#f92672">(</span>token, secret,algorithms<span style="color:#f92672">=[</span><span style="color:#e6db74">&#39;HS256&#39;</span><span style="color:#f92672">])</span>
    principalId <span style="color:#f92672">=</span> decoded<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;userRole&#34;</span><span style="color:#f92672">]</span>
    print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;principalId: &#34;</span> + principalId<span style="color:#f92672">)</span>
    <span style="color:#75715e"># Hoang end</span>

    <span style="color:#e6db74">&#34;&#34;&#34;this could be accomplished in a number of ways:&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;1. Call out to OAuth provider&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;2. Decode a JWT token inline&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;3. Lookup in a self-managed DB&#34;&#34;&#34;</span>
    <span style="color:#75715e"># principalId = &#34;user|a1b2c3d4&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;you can send a 401 Unauthorized response to the client by failing like so:&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;raise Exception(&#39;Unauthorized&#39;)&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;if the token is valid, a policy must be generated which will allow or deny access to the client&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;if access is denied, the client will recieve a 403 Access Denied response&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;if access is allowed, API Gateway will proceed with the backend integration configured on the method that was called&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;this function must generate a policy that is associated with the recognized principal user identifier.&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;depending on your use case, you might store policies in a DB, or generate them on the fly&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;keep in mind, the policy is cached for 5 minutes by default (TTL is configurable in the authorizer)&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;and will apply to subsequent calls to any method/resource in the RestApi&#34;&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;made with the same token&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;the example policy below denies access to all resources in the RestApi&#34;&#34;&#34;</span>
    tmp <span style="color:#f92672">=</span> event<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;methodArn&#39;</span><span style="color:#f92672">]</span>.split<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;:&#39;</span><span style="color:#f92672">)</span>
    apiGatewayArnTmp <span style="color:#f92672">=</span> tmp<span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>.split<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">)</span>
    awsAccountId <span style="color:#f92672">=</span> tmp<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>

    policy <span style="color:#f92672">=</span> AuthPolicy<span style="color:#f92672">(</span>principalId, awsAccountId<span style="color:#f92672">)</span>
    policy.restApiId <span style="color:#f92672">=</span> apiGatewayArnTmp<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
    policy.region <span style="color:#f92672">=</span> tmp<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>
    policy.stage <span style="color:#f92672">=</span> apiGatewayArnTmp<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>
    <span style="color:#75715e"># Hoang start</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>principalId <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">)</span>:
        policy.allowAllMethods<span style="color:#f92672">()</span>
    <span style="color:#66d9ef">else</span>:
        policy.denyAllMethods<span style="color:#f92672">()</span>
    <span style="color:#75715e"># Hoang end</span>
    <span style="color:#e6db74">&#34;&#34;&#34;policy.allowMethod(HttpVerb.GET, &#34;</span>/pets/*<span style="color:#e6db74">&#34;)&#34;&#34;&#34;</span>

    <span style="color:#75715e"># Finally, build the policy</span>
    authResponse <span style="color:#f92672">=</span> policy.build<span style="color:#f92672">()</span>
 
    <span style="color:#75715e"># new! -- add additional key-value pairs associated with the authenticated principal</span>
    <span style="color:#75715e"># these are made available by APIGW like so: $context.authorizer.&lt;key&gt;</span>
    <span style="color:#75715e"># additional context is cached</span>
    context <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#39;key&#39;</span>: <span style="color:#e6db74">&#39;value&#39;</span>, <span style="color:#75715e"># $context.authorizer.key -&gt; value</span>
        <span style="color:#e6db74">&#39;number&#39;</span> : 1,
        <span style="color:#e6db74">&#39;bool&#39;</span> : True
    <span style="color:#f92672">}</span>
    <span style="color:#75715e"># context[&#39;arr&#39;] = [&#39;foo&#39;] &lt;- this is invalid, APIGW will not accept it</span>
    <span style="color:#75715e"># context[&#39;obj&#39;] = {&#39;foo&#39;:&#39;bar&#39;} &lt;- also invalid</span>
 
    authResponse<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;context&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> context
    
    <span style="color:#66d9ef">return</span> authResponse

class HttpVerb:
    GET     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;GET&#34;</span>
    POST    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;POST&#34;</span>
    PUT     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PUT&#34;</span>
    PATCH   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PATCH&#34;</span>
    HEAD    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;HEAD&#34;</span>
    DELETE  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DELETE&#34;</span>
    OPTIONS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;OPTIONS&#34;</span>
    ALL     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span>

class AuthPolicy<span style="color:#f92672">(</span>object<span style="color:#f92672">)</span>:
    awsAccountId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The AWS account id the policy will be generated for. This is used to create the method ARNs.&#34;&#34;&#34;</span>
    principalId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The principal used for the policy, this should be a unique identifier for the end user.&#34;&#34;&#34;</span>
    version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2012-10-17&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The policy version used for the evaluation. This should always be &#39;2012-10-17&#39;&#34;&#34;&#34;</span>
    pathRegex <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;^[/.a-zA-Z0-9-\*]+</span>$<span style="color:#e6db74">&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The regular expression used to validate resource paths for the policy&#34;&#34;&#34;</span>

    <span style="color:#e6db74">&#34;&#34;&#34;these are the internal lists of allowed and denied methods. These are lists
</span><span style="color:#e6db74">    of objects and each object has 2 properties: A resource ARN and a nullable
</span><span style="color:#e6db74">    conditions statement.
</span><span style="color:#e6db74">    the build method processes these lists and generates the approriate
</span><span style="color:#e6db74">    statements for the final policy&#34;&#34;&#34;</span>
    allowMethods <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
    denyMethods <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>

    restApiId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The API Gateway API id. By default this is set to &#39;*&#39;&#34;&#34;&#34;</span>
    region <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The region where the API is deployed. By default this is set to &#39;*&#39;&#34;&#34;&#34;</span>
    stage <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;The name of the stage used in the policy. By default this is set to &#39;*&#39;&#34;&#34;&#34;</span>

    def __init__<span style="color:#f92672">(</span>self, principal, awsAccountId<span style="color:#f92672">)</span>:
        self.awsAccountId <span style="color:#f92672">=</span> awsAccountId
        self.principalId <span style="color:#f92672">=</span> principal
        self.allowMethods <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
        self.denyMethods <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>

    def _addMethod<span style="color:#f92672">(</span>self, effect, verb, resource, conditions<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds a method to the internal lists of allowed or denied methods. Each object in
</span><span style="color:#e6db74">        the internal list contains a resource ARN and a condition statement. The condition
</span><span style="color:#e6db74">        statement can be null.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> verb !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;*&#34;</span> and not hasattr<span style="color:#f92672">(</span>HttpVerb, verb<span style="color:#f92672">)</span>:
            raise NameError<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Invalid HTTP verb &#34;</span> + verb + <span style="color:#e6db74">&#34;. Allowed verbs in HttpVerb class&#34;</span><span style="color:#f92672">)</span>
        resourcePattern <span style="color:#f92672">=</span> re.compile<span style="color:#f92672">(</span>self.pathRegex<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">if</span> not resourcePattern.match<span style="color:#f92672">(</span>resource<span style="color:#f92672">)</span>:
            raise NameError<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Invalid resource path: &#34;</span> + resource + <span style="color:#e6db74">&#34;. Path should match &#34;</span> + self.pathRegex<span style="color:#f92672">)</span>

        <span style="color:#66d9ef">if</span> resource<span style="color:#f92672">[</span>:1<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/&#34;</span>:
            resource <span style="color:#f92672">=</span> resource<span style="color:#f92672">[</span>1:<span style="color:#f92672">]</span>

        resourceArn <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;arn:aws:execute-api:&#34;</span> +
            self.region + <span style="color:#e6db74">&#34;:&#34;</span> +
            self.awsAccountId + <span style="color:#e6db74">&#34;:&#34;</span> +
            self.restApiId + <span style="color:#e6db74">&#34;/&#34;</span> +
            self.stage + <span style="color:#e6db74">&#34;/&#34;</span> +
            verb + <span style="color:#e6db74">&#34;/&#34;</span> +
            resource<span style="color:#f92672">)</span>

        <span style="color:#66d9ef">if</span> effect.lower<span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;allow&#34;</span>:
            self.allowMethods.append<span style="color:#f92672">({</span>
                <span style="color:#e6db74">&#39;resourceArn&#39;</span> : resourceArn,
                <span style="color:#e6db74">&#39;conditions&#39;</span> : conditions
            <span style="color:#f92672">})</span>
        <span style="color:#66d9ef">elif</span> effect.lower<span style="color:#f92672">()</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;deny&#34;</span>:
            self.denyMethods.append<span style="color:#f92672">({</span>
                <span style="color:#e6db74">&#39;resourceArn&#39;</span> : resourceArn,
                <span style="color:#e6db74">&#39;conditions&#39;</span> : conditions
            <span style="color:#f92672">})</span>

    def _getEmptyStatement<span style="color:#f92672">(</span>self, effect<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Returns an empty statement object prepopulated with the correct action and the
</span><span style="color:#e6db74">        desired effect.&#34;&#34;&#34;</span>
        statement <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#39;Action&#39;</span>: <span style="color:#e6db74">&#39;execute-api:Invoke&#39;</span>,
            <span style="color:#e6db74">&#39;Effect&#39;</span>: effect<span style="color:#f92672">[</span>:1<span style="color:#f92672">]</span>.upper<span style="color:#f92672">()</span> + effect<span style="color:#f92672">[</span>1:<span style="color:#f92672">]</span>.lower<span style="color:#f92672">()</span>,
            <span style="color:#e6db74">&#39;Resource&#39;</span>: <span style="color:#f92672">[]</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> statement

    def _getStatementForEffect<span style="color:#f92672">(</span>self, effect, methods<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;This function loops over an array of objects containing a resourceArn and
</span><span style="color:#e6db74">        conditions statement and generates the array of statements for the policy.&#34;&#34;&#34;</span>
        statements <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>

        <span style="color:#66d9ef">if</span> len<span style="color:#f92672">(</span>methods<span style="color:#f92672">)</span> &gt; 0:
            statement <span style="color:#f92672">=</span> self._getEmptyStatement<span style="color:#f92672">(</span>effect<span style="color:#f92672">)</span>

            <span style="color:#66d9ef">for</span> curMethod in methods:
                <span style="color:#66d9ef">if</span> curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;conditions&#39;</span><span style="color:#f92672">]</span> is None or len<span style="color:#f92672">(</span>curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;conditions&#39;</span><span style="color:#f92672">])</span> <span style="color:#f92672">==</span> 0:
                    statement<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;Resource&#39;</span><span style="color:#f92672">]</span>.append<span style="color:#f92672">(</span>curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;resourceArn&#39;</span><span style="color:#f92672">])</span>
                <span style="color:#66d9ef">else</span>:
                    conditionalStatement <span style="color:#f92672">=</span> self._getEmptyStatement<span style="color:#f92672">(</span>effect<span style="color:#f92672">)</span>
                    conditionalStatement<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;Resource&#39;</span><span style="color:#f92672">]</span>.append<span style="color:#f92672">(</span>curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;resourceArn&#39;</span><span style="color:#f92672">])</span>
                    conditionalStatement<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;Condition&#39;</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> curMethod<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;conditions&#39;</span><span style="color:#f92672">]</span>
                    statements.append<span style="color:#f92672">(</span>conditionalStatement<span style="color:#f92672">)</span>

            statements.append<span style="color:#f92672">(</span>statement<span style="color:#f92672">)</span>

        <span style="color:#66d9ef">return</span> statements

    def allowAllMethods<span style="color:#f92672">(</span>self<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds a &#39;*&#39; allow to the policy to authorize access to all methods of an API&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Allow&#34;</span>, HttpVerb.ALL, <span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#f92672">[])</span>

    def denyAllMethods<span style="color:#f92672">(</span>self<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds a &#39;*&#39; allow to the policy to deny access to all methods of an API&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Deny&#34;</span>, HttpVerb.ALL, <span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#f92672">[])</span>

    def allowMethod<span style="color:#f92672">(</span>self, verb, resource<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds an API Gateway method (Http verb + Resource path) to the list of allowed
</span><span style="color:#e6db74">        methods for the policy&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Allow&#34;</span>, verb, resource, <span style="color:#f92672">[])</span>

    def denyMethod<span style="color:#f92672">(</span>self, verb, resource<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds an API Gateway method (Http verb + Resource path) to the list of denied
</span><span style="color:#e6db74">        methods for the policy&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Deny&#34;</span>, verb, resource, <span style="color:#f92672">[])</span>

    def allowMethodWithConditions<span style="color:#f92672">(</span>self, verb, resource, conditions<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds an API Gateway method (Http verb + Resource path) to the list of allowed
</span><span style="color:#e6db74">        methods and includes a condition for the policy statement. More on AWS policy
</span><span style="color:#e6db74">        conditions here: http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Condition&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Allow&#34;</span>, verb, resource, conditions<span style="color:#f92672">)</span>

    def denyMethodWithConditions<span style="color:#f92672">(</span>self, verb, resource, conditions<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Adds an API Gateway method (Http verb + Resource path) to the list of denied
</span><span style="color:#e6db74">        methods and includes a condition for the policy statement. More on AWS policy
</span><span style="color:#e6db74">        conditions here: http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Condition&#34;&#34;&#34;</span>
        self._addMethod<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Deny&#34;</span>, verb, resource, conditions<span style="color:#f92672">)</span>

    def build<span style="color:#f92672">(</span>self<span style="color:#f92672">)</span>:
        <span style="color:#e6db74">&#34;&#34;&#34;Generates the policy document based on the internal lists of allowed and denied
</span><span style="color:#e6db74">        conditions. This will generate a policy with two main statements for the effect:
</span><span style="color:#e6db74">        one statement for Allow and one statement for Deny.
</span><span style="color:#e6db74">        Methods that includes conditions will have their own statement in the policy.&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>self.allowMethods is None or len<span style="color:#f92672">(</span>self.allowMethods<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> and
            <span style="color:#f92672">(</span>self.denyMethods is None or len<span style="color:#f92672">(</span>self.denyMethods<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">))</span>:
            raise NameError<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;No statements defined for the policy&#34;</span><span style="color:#f92672">)</span>

        policy <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#39;principalId&#39;</span> : self.principalId,
            <span style="color:#e6db74">&#39;policyDocument&#39;</span> : <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#39;Version&#39;</span> : self.version,
                <span style="color:#e6db74">&#39;Statement&#39;</span> : <span style="color:#f92672">[]</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        policy<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;policyDocument&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;Statement&#39;</span><span style="color:#f92672">]</span>.extend<span style="color:#f92672">(</span>self._getStatementForEffect<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Allow&#34;</span>, self.allowMethods<span style="color:#f92672">))</span>
        policy<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;policyDocument&#39;</span><span style="color:#f92672">][</span><span style="color:#e6db74">&#39;Statement&#39;</span><span style="color:#f92672">]</span>.extend<span style="color:#f92672">(</span>self._getStatementForEffect<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Deny&#34;</span>, self.denyMethods<span style="color:#f92672">))</span>

        <span style="color:#66d9ef">return</span> policy
</code></pre></div><h3 id="62-rồi-run-các-command-sau-để-đóng-package-lambda-với-thư-viện-jwt-bên-ngoài-lại">6.2. Rồi run các command sau để đóng package lambda với thư viện jwt bên ngoài lại</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">pip install --target ./package python-jose
cd package/
zip -r9 <span style="color:#e6db74">${</span>OLDPWD<span style="color:#e6db74">}</span>/lambda_function.zip .
cd ..
zip -g lambda_function.zip lambda_function.py
</code></pre></div><h3 id="63-rồi-giờ-up-file-zip-này-lên-aws-lambda">6.3. Rồi giờ up file zip này lên AWS Lambda</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">aws lambda update-function-code --function-name tokenBasedLambdaAuthorizer --zip-file fileb://lambda_function.zip --region us-east-1
</code></pre></div><p>Vào nhìn nó sẽ có 1 đống thư viện ở bên cạnh như này:
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/lamba-with-jwt-lib.jpg" alt=""></p>
<h3 id="65-setup-authorizer-trong-api-gateway">6.5. Setup Authorizer trong API Gateway</h3>
<p>Trong API Gateway tạo 1 Authorizer như sau:
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/api-gateway-authorizer-jwt.jpg" alt=""></p>
<p>Đối với Method GET của resource /authors, add cái authorizer vừa tạo vào phần Authorization
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-resource-get-authors-method-request-jwt.jpg" alt=""></p>
<p>Enable CORS, sửa cái Access-Control-Allow-Origin lại bằng giá trị mình đã set ở Authorizer
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-enable-cors-jwt.jpg" alt=""></p>
<p>Deploy API.</p>
<h3 id="66-test-method-get-trên-postman">6.6. Test method GET trên Postman</h3>
<p>Nếu test trên console thì mặc định AWS sẽ bypass cái Authorizer luôn, nên phải test trên Postman.</p>
<p>Trước tiên cần tạo token để Lambda function có thể decode.</p>
<p>Vào jwt.io để tạo token, sửa code bên Decoded để tạo token ở cột Encoded.
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/jwt-io-encoded.jpg" alt=""></p>
<p>Tạo dc token rồi thì vào Postman test</p>
<p>Gửi đúng token của admin thì sẽ lấy dc data:
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-test-authorizer-postman-jwt-1.jpg" alt=""></p>
<p>Token mà sai thì nhận dc thông báo:
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-test-authorizer-postman-jwt-2.jpg" alt=""></p>
<p>Không gửi token mà gửi linh tinh thì nhận dc cái sau:
<img src="https://raw.githubusercontent.com/hoangmnsd/images-bucket/master/static/images/apigw-test-authorizer-postman-jwt-3.jpg" alt=""></p>
<p>Done!</p>
<p>Ngoài ra, 1 số web có ích, demo hoàn chỉnh về dùng Google-sigin button với API Gateway:
<a href="https://blog.codecentric.de/en/2018/04/aws-lambda-authorizer/">https://blog.codecentric.de/en/2018/04/aws-lambda-authorizer/</a></p>
<h2 id="source-tham-khảo">Source tham khảo</h2>
<p>Step 5:</p>
<p><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html">https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html</a></p>
<p><a href="https://medium.com/@checko/how-to-create-an-aws-lambda-authorizer-for-api-gateway-45df4745a0e">https://medium.com/@checko/how-to-create-an-aws-lambda-authorizer-for-api-gateway-45df4745a0e</a></p>
<p><a href="https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/blob/master/blueprints/python/api-gateway-authorizer-python.py">https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/blob/master/blueprints/python/api-gateway-authorizer-python.py</a></p>
<p>Step 6:</p>
<p><a href="http://www.awsomeblog.com/api-gateway-custom-authorization/">http://www.awsomeblog.com/api-gateway-custom-authorization/</a></p>
<p><a href="https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/blob/master/blueprints/python/api-gateway-authorizer-python.py">https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/blob/master/blueprints/python/api-gateway-authorizer-python.py</a></p>
<p><a href="https://blog.codecentric.de/en/2018/04/aws-lambda-authorizer/">https://blog.codecentric.de/en/2018/04/aws-lambda-authorizer/</a></p>
<p><a href="https://github.com/awslabs/aws-support-tools/issues/34">https://github.com/awslabs/aws-support-tools/issues/34</a></p>
<p><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html">https://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html</a></p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='categories'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z" />
</svg>
<span class='screen-reader-text'>Categories: </span><a class='category' href='/categories/tech-tutorials/'>Tech-Tutorials</a></div>
<div class='tags'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z" />
<line x1="7" y1="7" x2="7" y2="7" />
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/aws/'>AWS</a>, <a class='tag' href='/tags/apigateway/'>APIGateway</a>, <a class='tag' href='/tags/lambda/'>Lambda</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/posts/encrypt-aws-certified-developer-associate-note-cda/'>
        <span aria-hidden='true'><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><line x1="20" y1="12" x2="4" y2="12" />
<polyline points="10 18 4 12 10 6" />
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Aws Certified Developer Associate Note (CDA)</a>
    </div><div class='next-entry sep-before'>
      <a href='/posts/encrypt-aws-certified-solution-architect-associate-note-saa/'>
        <span class='screen-reader-text'>Next post: </span>Aws Certified Solution Architect Associate Note (SAA)<span aria-hidden='true'>Next <svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><line x1="4" y1="12" x2="20" y2="12" />
<polyline points="14 6 20 12 14 18" />
</svg>
</span>
      </a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><div id='submission-success' class='comment-submission-feedback'>
  <h4>Thank You!</h4>
  <span>Your comment has been submitted. It will appear on this page shortly!</span>
  <a href='#comments' class='button'>OK</a>
</div>

<div id='submission-failure' class='comment-submission-feedback'>
  <h4>Yikes, Sorry!</h4>
  <span>Error occured. Couldn&#39;t submit your comment. Please try again. Thank You!</span>
  <a href='#comments' class='button'>OK</a>
</div>




<div id='respond' class='comment-respond'>
  <h4 class='comment-reply-title'>Leave a comment<small>
      <a rel='nofollow' id='cancel-comment-reply-link' href='#respond' class='button' style='display:none' aria-label='Cancel comment'>Cancel</a>
    </small>
  </h4>
  <form action='http://132.145.71.114:8121/v2/entry/hoangmnsd/hoangmnsd/master/comments' method='post' id='comment-form' class='comment-form'>
    <input type='hidden' name='options[postId]' value='d4e6f563f77c7238c60570a7cafa8958'>
    <input type='hidden' name='options[redirect]' value='https://hoangmnsd.github.io/posts/secure-api-gateway-by-lambda-authorizer/#submission-success'>
    <input type='hidden' name='options[redirectError]' value='https://hoangmnsd.github.io/posts/secure-api-gateway-by-lambda-authorizer/#submission-failure'>

    <input type='address' name='fields[honeypot]' style='display:none'>
    <input type='hidden' name='fields[permalink]' value='/posts/secure-api-gateway-by-lambda-authorizer/'>
    <input type='hidden' name='fields[parent_id]' value=''><input type='hidden' name='options[reCaptcha][siteKey]' value='6LfVBkIbAAAAAMtm5T8t2odg9MK_V4QmMH8igQf3'>
      <input type='hidden' name='options[reCaptcha][secret]' value='voMPlsRRZcYpYg8FtEjNp61ZsDHFwt8sPUCm7t9p/gZ4OPlXwrdglRdZo1FcOAbY77CTjARHyyYYJSGiAFE1mQdmZDGz9Cnj9yhBzCpmfx0N/lzTlwxI/cACLS/ySlYYmhb6Rp7SuR7kIWpZN/XGuWzJFJCJ4jmtEbhRlkXubbupTDPbQ4e//H1Pv4rRQ7O65Bf/177T15v869Y59txPSgSwtGebU13WDNUxFEPw0xIuyeje6/1ioYU&#43;iZD/5jRQMYJNDgBC4v&#43;954PRzfOipLTYlVg2ncOa0WK&#43;OKxr4PybFtKRRTsPjSNHMdch9pBu5QECf5WG826pRH54r9/N0Q=='><div>
      <label for='comment'>Comment*</label>
      <textarea id='comment' name='fields[content]' required rows='3'></textarea>
    </div>
    <div>
      <label for='name'>Name*</label>
      <input id='name' name='fields[author]' type='text' required>
    </div>
    <div>
      <label for='email'>Email*</label>
      <input id='email' name='fields[email]' type='email' required>
    </div>
    <div>
      <label for='url'>Website</label>
      <input id='url' name='fields[site]' type='url'>
    </div><div class='g-recaptcha' data-sitekey='6LfVBkIbAAAAAMtm5T8t2odg9MK_V4QmMH8igQf3' data-callback="enableSubmitComment"></div>

      <script type="text/javascript">
        function enableSubmitComment(){
          document.getElementById("submitComment").disabled = false;
        }
      </script>

      <script async src='https://www.google.com/recaptcha/api.js'></script><div>
      <button type='submit' id="submitComment" disabled>Comment!</button>
    </div>
  </form>
</div>

</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/hoangmnsd' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" />
</svg>
</a>
      </li><li>
        <a href='mailto:hoangmnsd@gmail.com' target='_blank' rel='noopener me'>
          <span class='screen-reader-text'>Contact via Email</span><svg
  class="icon"
  xmlns="http://www.w3.org/2000/svg"
  viewbox="0 0 24 24"
  stroke-linecap="round"
  stroke-linejoin="round"
  stroke-width="2"
  aria-hidden="true"
><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
<polyline points="22,6 12,13 2,6" />
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2019-2023 hoangmsnd </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script><script src='/js/custom.js'></script>

</body>

</html>

